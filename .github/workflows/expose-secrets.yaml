name: Expose Secrets

on:
  workflow_call:
    inputs:
      deploy_environment:
        description: 'Choose an environment to deploy to: <staging|prod>'
        required: true
        default: "staging"
        type: string
      dot_env_params:
        description: 'A comma separated string with the names of the secrets or environment variables which we want to pass to .env'
        required: false
        default: ''
        type: string
env:
  DOT_ENV_PARAMS: ${{ inputs.dot_env_params }}
  
jobs:
  expose-secrets:
    runs-on: ubuntu-latest
    name: Expose secrets
    environment: ${{ inputs.deploy_environment }}
    steps:
      - name: ðŸ›« Checkout
        uses: actions/checkout@v3

      - name: ðŸ”§ Secret to Environment
        uses: oNaiPs/secrets-to-env-action@v1
        with:
          secrets: ${{ toJSON({ ...secrets, ...github.env }) }}
      
      - name: ðŸ““ Fill [dot] Env (Custom)
        if: ${{ env.DOT_ENV_PARAMS != '' }}
        uses: CallePuzzle/envvar-to-dotenv-action@v1.1.5
        with:
          variableNames: ${{ env.DOT_ENV_PARAMS }}
     
      - name: Create Artifact
        id: artifact_creation
        if: ${{ success() }}
        uses: actions/upload-artifact@v3.1.1
        with:
          name: variables
          path: |
            ${{github.workspace}}/.env
